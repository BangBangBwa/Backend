<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PostMapper">

  <insert id="save" parameterType="Post" keyProperty="id" useGeneratedKeys="true">
    INSERT INTO posts (post_type, member_id, title, content, status, created_id, created_at)
    VALUES (#{postType}, #{memberId}, #{title}, #{content}, #{status}, #{createdId}, #{createdAt})
  </insert>

  <select id="findById" parameterType="Long" resultType="post">
    SELECT * FROM posts WHERE id = #{id};
  </select>

  <select id="findAllByPostType" parameterType="PostType" resultType="post">
    SELECT * FROM posts WHERE post_type = #{postType};
  </select>


  <resultMap id="GetLatestPostsDtoMap" type="com.bangbangbwa.backend.domain.sns.common.dto.GetLatestPostsDto">
    <result property="streamerId" column="streamerId" />
    <result property="profileUrl" column="profileUrl" />
    <result property="postIdList" column="postIdList" />
  </resultMap>

  <select id="findPostsWithinLast24Hours" parameterType="PostType" resultMap="GetLatestPostsDtoMap">
    SELECT
    s.id AS streamerId,
    m.profile AS profileUrl,
    GROUP_CONCAT(p.id ORDER BY p.created_at DESC) AS postIdList
    FROM
    posts p
    JOIN
    members m ON p.member_id = m.id
    LEFT JOIN
    streamers s ON m.id = s.member_id
    WHERE
    p.created_at >= NOW() - INTERVAL '1' DAY
    AND p.post_type = #{postType}
    GROUP BY
    s.id, m.profile
    ORDER BY
    MAX(p.created_at) DESC;
  </select>


  <select id="getPostDetails" parameterType="map" resultType="com.bangbangbwa.backend.domain.sns.common.dto.GetPostDetailsDto$Response">
    SELECT
    p.id AS postId,
    p.member_id AS writerId,
    p.title AS title,
    p.content,
    m.profile AS profileUrl,
    m.nickname,
    c.content AS comment,
    CASE
      WHEN f.follower_id IS NOT NULL THEN true
      ELSE false
    END AS isFollowed
    FROM posts p
    LEFT JOIN members m ON p.member_id = m.id
    LEFT JOIN comments c ON c.post_id = p.id AND c.member_id = #{memberId}
    LEFT JOIN follow f ON f.follower_id = #{memberId} AND f.followee_id = p.member_id
    WHERE p.id = #{postId}
  </select>


</mapper>